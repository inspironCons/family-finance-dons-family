{% extends "base.html" %}

{% block title %}Laporan Keuangan{% endblock %}

{% block content %}
<!-- Script Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="bg-blue-600 pb-10 pt-6 px-6 rounded-b-3xl shadow-md text-white">
    <h1 class="text-xl font-bold mb-4">Laporan {{ month_name }}</h1>
    
    <!-- AI Insight -->
    {% if ai_insight %}
    <div class="bg-white/10 backdrop-blur-sm border border-white/20 p-4 rounded-xl mb-6 relative overflow-hidden">
        <div class="absolute -right-4 -top-4 text-white/10">
            <i class="ph ph-sparkle text-6xl"></i>
        </div>
        <div class="flex items-start space-x-3 relative z-10">
            <div class="bg-purple-500 p-2 rounded-lg shrink-0 shadow-lg">
                <i class="ph ph-magic-wand text-white text-lg"></i>
            </div>
            <div>
                <p class="text-[10px] uppercase font-bold text-purple-200 mb-1">Kata Gemini Advisor</p>
                <p class="text-sm font-medium leading-snug">{{ ai_insight }}</p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Summary Card -->
    <div class="flex justify-between text-center bg-blue-700 rounded-xl p-4 border border-blue-500">
        <div>
            <p class="text-xs text-blue-200 uppercase">Pemasukan</p>
            <p class="font-bold text-green-300">Rp {{ "{:,.0f}".format(total_income).replace(',', '.') }}</p>
        </div>
        <div class="w-px bg-blue-500 h-10 mx-2"></div>
        <div>
            <p class="text-xs text-blue-200 uppercase">Pengeluaran</p>
            <p class="font-bold text-red-300">Rp {{ "{:,.0f}".format(total_expense).replace(',', '.') }}</p>
        </div>
    </div>
    
    <div class="mt-4 text-center">
        <p class="text-xs text-blue-100">Cashflow Bersih</p>
        <p class="text-2xl font-bold {{ 'text-green-300' if net_cashflow >= 0 else 'text-red-300' }}">
            {{ '+' if net_cashflow > 0 else '' }} Rp {{ "{:,.0f}".format(net_cashflow).replace(',', '.') }}
        </p>
    </div>
</div>

<div class="px-6 -mt-6 pb-24">
    
    <!-- Chart Section -->
    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6">
        <h2 class="font-bold text-gray-800 mb-6 flex items-center">
            <i class="ph ph-chart-pie mr-2 text-blue-600"></i> Alokasi Pengeluaran
        </h2>
        
        {% if category_stats %}
            <div class="h-72 relative">
                <canvas id="expenseChart"></canvas>
                <!-- Center Text Overlay -->
                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                    <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Total</p>
                    <p class="text-lg font-extrabold text-gray-800">Rp {{ "{:,.0f}".format(total_expense).replace(',', '.') }}</p>
                </div>
            </div>
            
            <div class="flex flex-wrap justify-center gap-4 mt-6">
                <div class="flex items-center text-[10px] font-bold text-gray-500 bg-gray-50 px-2 py-1 rounded-md border border-gray-100">
                    <span class="w-2 h-2 bg-gray-600 rounded-full mr-1.5"></span> WAJIB
                </div>
                <div class="flex items-center text-[10px] font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded-md border border-blue-100">
                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-1.5"></span> BUTUH
                </div>
                <div class="flex items-center text-[10px] font-bold text-purple-500 bg-purple-50 px-2 py-1 rounded-md border border-purple-100">
                    <span class="w-2 h-2 bg-purple-500 rounded-full mr-1.5"></span> INGIN
                </div>
            </div>
        {% else %}
            <div class="text-center py-10 text-gray-400">
                <i class="ph ph-chart-pie-slice text-4xl mb-2"></i>
                <p>Belum ada data pengeluaran bulan ini.</p>
            </div>
        {% endif %}
    </div>

    <!-- Top Spending List -->
    {% if category_stats %}
    <div class="space-y-4">
        <h3 class="font-bold text-gray-800 text-sm uppercase tracking-wider">Detail Kategori</h3>
        
        {% for stat in category_stats %}
        <div class="bg-white p-4 rounded-xl border border-gray-100 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center
                    {% if stat.priority_group.value == 'fixed' %} bg-gray-100 text-gray-600
                    {% elif stat.priority_group.value == 'living' %} bg-blue-100 text-blue-600
                    {% else %} bg-purple-100 text-purple-600 {% endif %}">
                    <i class="ph ph-{{ stat.icon }} text-xl"></i>
                </div>
                <div>
                    <p class="font-bold text-gray-800 text-sm">{{ stat.name }}</p>
                    <p class="text-[10px] text-gray-500 uppercase">{{ stat.priority_group.value }}</p>
                </div>
            </div>
            <div class="text-right">
                <p class="font-bold text-gray-800">Rp {{ "{:,.0f}".format(stat.total).replace(',', '.') }}</p>
                <!-- Persentase sederhana -->
                <p class="text-xs text-gray-400">{{ "{:.1f}".format(stat.total / total_expense * 100) }}%</p>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script>
    {% if category_stats %}
    const ctx = document.getElementById('expenseChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: {{ chart_labels | tojson }},
            datasets: [{
                data: {{ chart_data | tojson }},
                backgroundColor: {{ chart_colors | tojson }},
                borderWidth: 0,
                hoverOffset: 15,
                borderRadius: 8, // Membuat ujung potongan membulat
                spacing: 5 // Memberi jarak antar potongan
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.raw || 0;
                            return ` ${label}: Rp ${new Intl.NumberFormat('id-ID').format(value)}`;
                        }
                    }
                }
            },
            cutout: '80%', // Lebih tipis agar teks tengah lega
        }
    });
    {% endif %}
</script>
{% endblock %}
